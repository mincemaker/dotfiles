echo "loading..."

" Firefoxのタブを開く位置をデフォで現在のタブの右隣にする（※ gBrowser.addTabの改造）"
" http://d.hatena.ne.jp/wlt/20110112/1294859530
js <<EOM
gBrowser.addTab = liberator.eval(
    '(' +
    gBrowser.addTab.toSource()
            .replace(/var aRelatedToCurrent;/, 'var aRelatedToCurrent = true;')
            .replace(/aRelatedToCurrent = params\.relatedToCurrent;/, 'aRelatedToCurrent = params.relatedToCurrent === undefined ? true : params.relatedToCurrent;') +
    ')',
    gBrowser.addTab);
EOM

" Gmail/LDR/Fastladder/はてブでは新規タブをバックグラウンドで開く
autocmd LocationChange '^(?!https?://(mail\.google\.com/(mail|a)/|(reader\.livedoor|fastladder)\.com/reader/|b\.hatena\.ne\.jp/(?!(entry|articles|guide))))' :set! browser.tabs.loadDivertedInBackground=false
autocmd LocationChange '^https?://(mail\.google\.com/(mail|a)/|(reader\.livedoor|fastladder)\.com/reader/|b\.hatena\.ne\.jp/(?!(entry|articles|guide)))' :set! browser.tabs.loadDivertedInBackground=true

"" init
set gui=none,tabs
set wildmode=list:full
set autocomplete
set showstatuslinks=2
set insertmode
set complete=tsl
set visualbell
set history=1000
set hlsearch
set focuscontent
set hintmatching=custom
"]]
set nextpattern+=次(の)?ページ,→\b,下一頁,Следующая,다음
"[[
set previouspattern+=prev,\b←,前(の)?ページ
set hintchars=hjklasdf

"" mapping
noremap _ ma
noremap } 'a
noremap <C-c> :echo Yank!<CR>Y

nnoremap j 3j
nnoremap k 3k
nnoremap J <PageDown>
nnoremap K <PageUp>
noremap <Tab> <C-v><Tab>
nnoremap I <C-esc>
nnoremap U :undo<Space>
nnoremap s <esc>:tabopen google 

map ! :set invum<CR>
map ,s :so ~/.vimperatorrc<CR>
map ,c :subscldr -rate 3
map ,t :tw<CR>
map ,T :tw!<CR>
map ,@ :tw!@
map ,mf :mr favotter-new
map ,mF :mr favotter-new mincemaker<CR>

noremap <BS> <A-Left>

nmap h <A-Left>
nmap l <A-Right>

noremap H gT
noremap L gt
map <S-Right> :tabmove! +1<CR>
map <S-Left>  :tabmove! -1<CR>

noremap <C-1> :set gui=all<cr>
noremap <C-2> :set gui=nobookmarks,nomenu,nonavigation,tabs,statuslinetoolbar<cr>
noremap <C-3> :set gui=none,notabs,statuslinetoolbar<cr>

" ex modeでC-jを無効化
cmap <C-j> <Nop>

" ex modeでUp/DownをTab/S-Tab互換に
cmap <Down> <Tab>
cmap <Up> <S-Tab>

" vimperator 1.2 06-17以降でOS側のショートカットが効かなくなったので代替
imap <C-f> <Right>
imap <C-b> <Left>
imap <C-n> <Down>
cmap <C-f> <Right>
cmap <C-b> <Left>
cmap <C-n> <Down>
cmap <C-p> <Up>
map <M-c> <C-v><M-c>
imap <M-a> <C-v><M-a>
imap <M-z> <C-v><M-z>
imap <M-x> <C-v><M-x>
imap <M-c> <C-v><M-c>
imap <M-v> <C-v><M-v>
cmap <M-a> <C-v><M-a>
cmap <M-z> <C-v><M-z>
cmap <M-x> <C-v><M-x>
cmap <M-c> <C-v><M-c>

" toolbarbutton feed icon
style -name toolbarbutton-feed-icon chrome://* #liberator-customize-toolbar > #feed-button { border: none !important; background: none !important; min-width: 0 !important; padding: 0 !important; }

" アマゾンのURLをきれいにする
" via. http://vimperator.g.hatena.ne.jp/nokturnalmortum/20100918/1284806941
cabbrev -j .amazon    let(asin=content.document.getElementById('ASIN').value,base='http://amazon.jp/',res)['dp/','o/ASIN/','gp/product/'].some(function(it)((content.document.location.pathname.indexOf(it)>1)&&(res=base+it+asin)))&&res;

" ime_controller.js の代わり
style -name commandline-ime chrome://* #liberator-commandline-command input {ime-mode: inactive;}

"タイトルバーのキャプション
"javascript <<EOF
"if(!document.getElementById("titlebar-caption")) {
"  let mainWindow = document.getElementById("main-window");
"
"  let (broadcaster = document.createElement("broadcaster")) {
"    with(broadcaster) {
"      setAttribute("id", "windowTitle");
"      setAttribute("value", mainWindow.getAttribute("title"));
"    }
"    mainWindow.addEventListener("DOMAttrModified", function(e) {
"      if(e.attrName == "title")
"         broadcaster.setAttribute("value", mainWindow.getAttribute("title"));
"    }, true);
"    document.getElementById("mainBroadcasterSet").appendChild(broadcaster);
"  }
"
"  let xml = <label id="titlebar-caption" crop="end" xmlns="http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul">
"    <observes element="windowTitle" attribute="value" />
"  </label>
"
"  let (titlebarSpacer = document.getElementById("titlebar-spacer"))
"    titlebarSpacer.parentNode.insertBefore(document.adoptNode(new DOMParser().parseFromString(xml.toXMLString(), "application/xml").documentElement, true), titlebarSpacer);
"}
"EOF

" toolbarbutton
style -name liberator-customize-toolbar chrome://* #liberator-customize-toolbar { -moz-appearance: none !important; }
style -name toolbarbutton-feed-icon chrome://* #liberator-customize-toolbar > #feed-button { border: none !important; background: none !important; min-width: 0 !important; padding: 0 !important; }

" ------------------------------------------------------------------------------
"" Plugins

let g:plugin_loader_roots = "~/.vimperator/vimperator-plugins/ ~/.vimperator/load"
js <<EOM
liberator.globalVariables.plugin_loader_plugins = `
  _libly
  appendAnchor
  auto_source
  bitly
  caret-hint
  copy
  direct_bookmark
  feedSomeKeys_3
  hint-tombloo
  ldrize_cooperation
  ldrize_cooperation_fetch_flv
  lo
  migemized_find
  migemo_completion
  migemo_hint
  multi_requester
  maine_coon
  opener
  pino
  pluginManager
  prevent-pseudo-domain
  proxy
  reload-image
  sbmcommentsviewer
  spatial-navigation
  statusline-toolbar
  tombloo
  twittperator
  walk-input
  x-hint
`.split(/\s+/).filter(function(n) !/^!/.test(n));
EOM

" ime_controller.js
let g:ex_ime_mode = "inactive"
let g:textarea_ime_mode = "inactive"

" ldr_cooperation.js
let g:ldrc_captureMappings = "['t', 'T', 'h', 'l', 'j', 'k', 'p', 'o', '?']"
let g:ldrc_hints = "true"
"let g:ldrc_intelligence_bind = "true"
"let g:ldrc_skip = "0.5"
nnoremap Q :toggleldrc<CR>

" sbmcommentsviewer
map . :viewSBMComments -t h<CR>
let g:def_sbm_format = "id,timestamp,tags,comment"

let g:ldrc_captureMappings = "['?','j','k','p','o']"
let g:styles = "niconico,ldr,mixi"

" direct_bookmark
let g:direct_sbm_use_services_by_tag = 'd'
let g:direct_sbm_use_services_by_post = "d"
let g:direct_sbm_is_normalize = "true"
let g:direct_sbm_is_use_migemo = "true"
map a :sbm 

" pino
let g:pinoBaseURL = "http://192.168.1.6:3000"

command! -nargs=+ lazy autocmd VimperatorEnter .* <args>
lazy fmaps -u='mail\.google\.com/mail' c / j k n p o u e x s r a # [ ] ? gi gs gt gd ga gc
lazy fmaps -u='mail\.google\.com/mail/.*/[0-9a-f]+$' c / j,n k,p n,j p,k o u e x s r a # [ ] ? gi gs gt gd ga gc
lazy fmaps -u='www\.google\.co\.jp/reader' -events=vkeypress j k n p m s v A r S N P X O gh ga gs gt gu u / ? J K
lazy fmaps -u='(fastladder|livedoor)\.com/reader' j k s a p o v c i,p g <Space> <S-Space> z b < > q w e,g r i,tj b
lazy fmaps -u='(fastladder|livedoor)\.com/reader' -events=vkeypress J
lazy fmaps -u=':3000/reader' j k s a p o v c g <Space> <S-Space> z b < > q w e,g r i,tj
lazy fmaps -u=':3000/reader' -events=vkeypress J
lazy fmaps -u='https?://www\.rememberthemilk\.com/home/' j k m i c t ? d F,f G,g S,s L,l Y,y H,h M,m <Del> <C-S-Left> <C-S-Right>
lazy fmaps -u='http://code.google.com/p/vimperator-labs/issues/list' o j k
lazy fmaps -u='http://code.google.com/p/vimperator-labs/issues/detail' u
command! -nargs=+ lazyfmapstumblr lazy fmaps -u='http://\w+\.tumblr\.com' <args>
lazyfmapstumblr j k t a p
lazyfmapstumblr i,tj

":javascript FirebugCommandLineAPI.prototype.vimperator = liberator

" Greasemonkey 0.9.13 patch
" cf.http://d.hatena.ne.jp/littlefolk/20110625/p1
js <<EOM
autocommands.add(
  'VimperatorEnter', '.*',
  function () {
    let Cc = Components.classes['@greasemonkey.mozdev.org/greasemonkey-service;1'];
    if (Cc) {
      Cc = Cc.getService().wrappedJSObject;
      if (Cc.injectScripts.toSource().search('sharedObject') == -1) {
        Cc.injectScripts = liberator.eval(
          Cc.injectScripts.toSource()
            .replace(/(?=(?:var|let) (?:firebugConsole))/,'var sharedObject = {};')
            .replace(/(?=var requires)/, 'sandbox.sharedObject = sharedObject;')
            .replace(/(?=}$)/, 'return sharedObject;'),
        Cc.injectScripts);
      };
    };
  });
EOM

" disable accesskey
set! ui.key.generalAccessKey=0
" open bookmarks in background
set! browser.tabs.loadBookmarksInBackground=true

" verttabbar
"set! browser.tabs.closeButton=2
"set! verttabbar.width=200
"set showtabline=1

" copy.js
javascript <<EOM
liberator.globalVariables.copy_templates = [
  { label: 'titleAndURL',    value: '%TITLE%\n%URL%' },
  { label: 'title',          value: '%TITLE%', map: ',y' },
  { label: 'anchor',         value: '<a href="%URL%">%TITLE%</a>' },
  { label: 'selanchor',      value: '<a href="%URL%" title="%TITLE%">%SEL%</a>' },
  { label: 'htmlblockquote', value: '<blockquote cite="%URL%" title="%TITLE%">%HTMLSEL%</blockquote>' },
  { label: 'ASIN',   value: 'copy ASIN code from Amazon', custom: function(){return 'http://amazon.co.jp/o/ASIN/' + content.document.getElementById('ASIN').value;} },
];
EOM

" no-reading.js
let g:no_reading_on_statusline=1
let g:no_reading_statusline_limit=1000

javascript <<EOM
commands.addUserCommand(
  ['removeCookieOfYourfile'],
  'removeCookieOfYourfile',
  function() {
    liberator.execute('cookiemanager remove yourfilehostdatabase.com/');
    liberator.execute('cookiemanager remove yourfilehost.com/');
    liberator.execute('cookiemanager remove yourlifehost.jp/');
        }
);
EOM

" tombloo.js
map A :tombloo!Bookmark<CR>

" twittperator
let g:twittperator_use_chirp = 1
let g:twittperator_history_limit = 5000
let g:twittperator_use_ssl_connection_for_api_ep = 1
let g:twittperator_screen_name = "mincemaker"
let g:twittperator_lang = "ja"
let g:twittperator_count = 50
let g:twittperator_plugin_echo_tweet = 1
let g:twittperator_plugin_twlist_win = 1
let g:twittperator_plugin_twsidebar = 1
let g:twittperator_plugin_twsidebar_expand_url = 1
cabbrev -j .reply let (e=doc.querySelector('.hentry.status'))('@' + e.getAttribute('class').match(/u-(\S+)/)[1] + "#" + e.getAttribute('id').match(/\d+/))

js<<EOM
(function () {
  function makeAudio (path, volume) {
    let audio = new Audio(path);
    // XXX 効いてない
    if (volume)
      audio.volume = volume;
    return audio;
  }

  liberator.globalVariables.twittperator_sidebar_config = {
    // for Keyword タグ
    keyword: /mince|vimp|sst|xss/i,

    // ツイート内に含まれると、表示上抹殺される (reply とか除く
    vanish: /たらRT/i,

    // 自分のスクリーンネーム
    screenName: 'mincemaker',

    // 自分のその他の名前
    myNames: /mince|みんち|挽肉屋/i,

    // ログファイル てけとーなフォーマットで保存されます
    //logFile: io.File('~/.chirpstream'),
    //myLogFile: io.File('~/.mychirpstream'),

    // 各イベント時に音がなる
    sound: {
    },

    // 文字のサイズ
    fontSize: 12,

    // リストの最大保持数
    listMax: 100,

    // リストの表示順（昇順／降順）
    listAscendingOrder: true,

    // ツイートされる度に最新ツイート位置までスクロールする
    listAutoScroll: true,

    // 日本語だけ for filter stream
    jpOnly: true,

    // 地震ツイートの本文に場所をくっつける
    earthquake: true,

    // サイドバーを閉じても機能を停止しない
    dontStop: true,

    // サイドバーが閉じていても、こっそり開始しておく
    silentStart: true,
  };
})();
EOM



" RefControl
set! refcontrol.actions="@DEFAULT= ameba.jp= dtiblog.com=@FORGE fc2.com= image.itmedia.co.jp=@FORGE img.itmedia.co.jp=@FORGE minkch.com=@NORMAL momi7.momi3.net=@FORGE www.b-idol.com=@FORGE xyzzz.blog.shinobi.jp=@FORGE"

" proxy
javascript <<EOM
liberator.globalVariables.proxy_settings = [
  {
    conf_name: 'disable',
    conf_usage: 'direct connection',
    settings: [
      {
         label: 'type',
         param: 0
      }
    ]
  },
  {
    conf_name: 'localhost',
    conf_usage: 'use squid cache proxy',
    settings: [
      {
         label: 'type',
         param: 1
      },
      {
         label: 'http',
         param: 'localhost'
      },
      {
         label: 'http_port',
         param: 8080
      },
      {
         label: 'ssl',
         param: 'localhost'
      },
      {
         label: 'ssl_port',
         param: 8080
      }
    ]
  },
  {
    conf_name: 'polipo',
    conf_usage: 'use polipo cache proxy',
    settings: [
      {
        label: 'type',
        param: 1
      },
      {
        label: 'http',
        param: 'localhost'
      },
      {
        label: 'http_port',
        param: 8123
      }
    ]
  }
];
EOM

colorscheme sweets_snaka

source ~/.vimperatorrc.css

echo "vimperatorrc loaded."

